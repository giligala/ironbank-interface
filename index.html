<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Iron Bank Interface</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }
        .container {
            background-color: #f5f5f5;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
        }
        .button {
            background-color: #4CAF50;
            border: none;
            color: white;
            padding: 15px 32px;
            text-align: center;
            text-decoration: none;
            display: inline-block;
            font-size: 16px;
            margin: 4px 2px;
            cursor: pointer;
            border-radius: 4px;
        }
        .input-group {
            margin: 10px 0;
        }
        input {
            padding: 10px;
            margin-right: 10px;
            border-radius: 4px;
            border: 1px solid #ddd;
        }
        #statusMessage {
            color: red;
            margin-top: 10px;
        }
    </style>
</head>
<body>
    <h1>Iron Bank USDT Market</h1>
    
    <div class="container">
        <h2>Market Stats</h2>
        <p>Supply APY: <span id="supplyApy">Loading...</span>%</p>
        <p>Borrow APY: <span id="borrowApy">Loading...</span>%</p>
        <p>Total Supply: <span id="totalSupply">Loading...</span> USDT</p>
        <p>Total Borrow: <span id="totalBorrow">Loading...</span> USDT</p>
    </div>

    <div class="container">
        <h2>Your Balances</h2>
        <p>USDT Balance: <span id="usdtBalance">Loading...</span></p>
        <p>ibUSDT Balance: <span id="ibUsdtBalance">Loading...</span></p>
    </div>

    <div class="container">
        <h2>Supply</h2>
        <div class="input-group">
            <input type="number" id="supplyAmount" placeholder="Amount">
            <button class="button" id="supplyButton">Supply</button>
        </div>
    </div>

    <div class="container">
        <h2>Withdraw</h2>
        <div class="input-group">
            <input type="number" id="withdrawAmount" placeholder="Amount">
            <button class="button" id="withdrawButton">Withdraw</button>
        </div>
    </div>

    <div class="container">
        <h2>Borrow</h2>
        <div class="input-group">
            <input type="number" id="borrowAmount" placeholder="Amount">
            <button class="button" id="borrowButton">Borrow</button>
        </div>
    </div>

    <div class="container">
        <h2>Repay</h2>
        <div class="input-group">
            <input type="number" id="repayAmount" placeholder="Amount">
            <button class="button" id="repayButton">Repay</button>
        </div>
    </div>

    <div id="statusMessage"></div>

    <script src="https://cdn.ethers.io/lib/ethers-5.0.umd.min.js" type="application/javascript"></script>
    <script>
        const CONTRACT_ADDRESS = "0x994A258c7Dec633865ACf5f89A572e6691DA35af";
        const USDT_ADDRESS = "0x55d398326f99059fF775485246999027B3197955";
        
        const CONTRACT_ABI = [
            "function mint(uint256) external returns (uint256)",
            "function redeem(uint256) external returns (uint256)",
            "function redeemUnderlying(uint256) external returns (uint256)",
            "function borrow(uint256) external returns (uint256)",
            "function repayBorrow(uint256) external returns (uint256)",
            "function balanceOf(address) external view returns (uint256)",
            "function totalSupply() external view returns (uint256)",
            "function totalBorrows() external view returns (uint256)",
            "function borrowRatePerBlock() external view returns (uint256)",
            "function supplyRatePerBlock() external view returns (uint256)",
            "function exchangeRateStored() public view returns (uint256)"
        ];

        const USDT_ABI = [
            "function approve(address, uint256) external returns (bool)",
            "function allowance(address, address) external view returns (uint256)",
            "function balanceOf(address) external view returns (uint256)"
        ];

        let provider;
        let signer;
        let contract;
        let usdtContract;

        async function initialize() {
            if (typeof window.ethereum === 'undefined') {
                alert('Please install MetaMask!');
                return;
            }

            try {
                await window.ethereum.request({ method: 'eth_requestAccounts' });
                
                provider = new ethers.providers.Web3Provider(window.ethereum);
                signer = provider.getSigner();
                contract = new ethers.Contract(CONTRACT_ADDRESS, CONTRACT_ABI, signer);
                usdtContract = new ethers.Contract(USDT_ADDRESS, USDT_ABI, signer);

                setupEventListeners();
                updateMarketStats();
                updateBalances();

                // 監聽鏈上事件
                provider.on("block", () => {
                    updateMarketStats();
                    updateBalances();
                });
            } catch (error) {
                console.error('Error initializing:', error);
                document.getElementById('statusMessage').innerText = 'Error initializing application';
            }
        }

        async function updateMarketStats() {
            try {
                const supplyRate = await contract.supplyRatePerBlock();
                const borrowRate = await contract.borrowRatePerBlock();
                const totalSupply = await contract.totalSupply();
                const totalBorrow = await contract.totalBorrows();
                const exchangeRate = await contract.exchangeRateStored();

                const blocksPerYear = 365 * 24 * 60 * 60 / 3;
                const supplyApy = (Math.pow((1 + (supplyRate / 1e18)), blocksPerYear) - 1) * 100;
                const borrowApy = (Math.pow((1 + (borrowRate / 1e18)), blocksPerYear) - 1) * 100;

                // 使用 exchangeRate 進行換算
                const actualTotalSupply = totalSupply.mul(exchangeRate).div(ethers.BigNumber.from(10).pow(18));
                
                document.getElementById('supplyApy').innerText = supplyApy.toFixed(2);
                document.getElementById('borrowApy').innerText = borrowApy.toFixed(2);
                document.getElementById('totalSupply').innerText = ethers.utils.formatUnits(actualTotalSupply, 6);
                document.getElementById('totalBorrow').innerText = ethers.utils.formatUnits(totalBorrow, 6);
                
                // 顯示當前匯率供參考
                const exchangeRateFormatted = parseFloat(ethers.utils.formatUnits(exchangeRate, 18));
                console.log('Current exchange rate:', exchangeRateFormatted);
            } catch (error) {
                console.error('Error updating market stats:', error);
                document.getElementById('statusMessage').innerText = 'Error updating market stats';
            }
        }

        async function updateBalances() {
            try {
                const address = await signer.getAddress();
                const exchangeRate = await contract.exchangeRateStored();
                
                const usdtBalance = await usdtContract.balanceOf(address);
                const ibUsdtBalance = await contract.balanceOf(address);
                
                // 計算實際的 USDT 價值
                const actualUsdtValue = ibUsdtBalance.mul(exchangeRate).div(ethers.BigNumber.from(10).pow(18));
                
                document.getElementById('usdtBalance').innerText = 
                    ethers.utils.formatUnits(usdtBalance, 6);
                document.getElementById('ibUsdtBalance').innerText = 
                    `${ethers.utils.formatUnits(ibUsdtBalance, 6)} (≈ ${ethers.utils.formatUnits(actualUsdtValue, 6)} USDT)`;
                
                const allowance = await usdtContract.allowance(address, CONTRACT_ADDRESS);
                if (allowance.eq(0)) {
                    document.getElementById('supplyButton').innerText = 'Approve USDT';
                } else {
                    document.getElementById('supplyButton').innerText = 'Supply';
                }
            } catch (error) {
                console.error('Error updating balances:', error);
                document.getElementById('statusMessage').innerText = 'Error updating balances';
            }
        }

        function setupEventListeners() {
            document.getElementById('supplyButton').addEventListener('click', async () => {
                try {
                    const amount = document.getElementById('supplyAmount').value;
                    const address = await signer.getAddress();
                    const allowance = await usdtContract.allowance(address, CONTRACT_ADDRESS);

                    if (allowance.eq(0)) {
                        const tx = await usdtContract.approve(
                            CONTRACT_ADDRESS,
                            ethers.constants.MaxUint256
                        );
                        await tx.wait();
                        document.getElementById('supplyButton').innerText = 'Supply';
                    } else {
                        const tx = await contract.mint(ethers.utils.parseUnits(amount, 6));
                        await tx.wait();
                        updateBalances();
                    }
                } catch (error) {
                    console.error('Error in supply:', error);
                    document.getElementById('statusMessage').innerText = 'Error in supply operation';
                }
            });

            document.getElementById('withdrawButton').addEventListener('click', async () => {
                try {
                    const amount = document.getElementById('withdrawAmount').value;
                    const tx = await contract.redeemUnderlying(ethers.utils.parseUnits(amount, 6));
                    await tx.wait();
                    updateBalances();
                } catch (error) {
                    console.error('Error in withdraw:', error);
                    document.getElementById('statusMessage').innerText = 'Error in withdraw operation';
                }
            });

            document.getElementById('borrowButton').addEventListener('click', async () => {
                try {
                    const amount = document.getElementById('borrowAmount').value;
                    const tx = await contract.borrow(ethers.utils.parseUnits(amount, 6));
                    await tx.wait();
                    updateBalances();
                } catch (error) {
                    console.error('Error in borrow:', error);
                    document.getElementById('statusMessage').innerText = 'Error in borrow operation';
                }
            });

            document.getElementById('repayButton').addEventListener('click', async () => {
                try {
                    const amount = document.getElementById('repayAmount').value;
                    const tx = await contract.repayBorrow(ethers.utils.parseUnits(amount, 6));
                    await tx.wait();
                    updateBalances();
                } catch (error) {
                    console.error('Error in repay:', error);
                    document.getElementById('statusMessage').innerText = 'Error in repay operation';
                }
            });
        }

        initialize();
    </script>
</body>
</html>