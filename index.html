<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Iron Bank Interface</title>
    <script src="https://unpkg.com/ethers@5.7.0/dist/ethers.umd.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }

        .section {
            background-color: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        h1, h2 {
            color: #333;
        }

        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
        }

        .stat-item {
            background-color: #f8f9fa;
            padding: 15px;
            border-radius: 5px;
        }

        .input-group {
            margin-bottom: 15px;
        }

        input {
            width: 100%;
            padding: 8px;
            margin-top: 5px;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-sizing: border-box;
        }

        button {
            background-color: #28a745;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }

        button:hover {
            background-color: #218838;
        }

        #connectWallet {
            background-color: #007bff;
        }

        #connectWallet:hover {
            background-color: #0056b3;
        }

        #refreshBalance {
            margin-top: 10px;
            background-color: #007bff;
        }

        #refreshBalance:hover {
            background-color: #0056b3;
        }

        .action-buttons {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 10px;
        }

        #statusMessage {
            color: #dc3545;
            margin-top: 10px;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <div class="section">
        <h1>Iron Bank USDT Market</h1>
        <button id="connectWallet">Connect Wallet</button>
        <p id="walletAddress">Wallet: Not Connected</p>
        <p id="statusMessage"></p>
    </div>

    <div class="section">
        <h2>Market Statistics</h2>
        <div class="stats">
            <div class="stat-item">
                <p>Supply APY: <span id="supplyApy">-</span>%</p>
            </div>
            <div class="stat-item">
                <p>Borrow APY: <span id="borrowApy">-</span>%</p>
            </div>
            <div class="stat-item">
                <p>Total Supply: <span id="totalSupply">-</span> USDT</p>
            </div>
            <div class="stat-item">
                <p>Total Borrow: <span id="totalBorrow">-</span> USDT</p>
            </div>
        </div>
    </div>

    <div class="section">
        <h2>Your Balances</h2>
        <div class="stats">
            <div class="stat-item">
                <p>USDT Balance: <span id="usdtBalance">-</span> USDT</p>
            </div>
            <div class="stat-item">
                <p>ibUSDT Balance: <span id="ibUsdtBalance">-</span> ibUSDT</p>
            </div>
            <button id="refreshBalance">Refresh Balances</button>
        </div>
    </div>

    <div class="section">
        <h2>Supply</h2>
        <div class="input-group">
            <input type="number" id="supplyAmount" placeholder="Amount to supply">
            <button id="supplyButton">Supply</button>
        </div>
    </div>

    <div class="section">
        <h2>Withdraw</h2>
        <div class="input-group">
            <input type="number" id="withdrawAmount" placeholder="Amount to withdraw">
            <button id="withdrawButton">Withdraw</button>
        </div>
    </div>

    <div class="section">
        <h2>Borrow</h2>
        <div class="input-group">
            <input type="number" id="borrowAmount" placeholder="Amount to borrow">
            <button id="borrowButton">Borrow</button>
        </div>
    </div>

    <div class="section">
        <h2>Repay</h2>
        <div class="input-group">
            <input type="number" id="repayAmount" placeholder="Amount to repay">
            <button id="repayButton">Repay</button>
        </div>
    </div>

    <script>
        // 確保 ethers 已加載
        window.addEventListener('load', function() {
            if (typeof ethers === 'undefined') {
                console.error('Ethers.js failed to load');
                document.getElementById('statusMessage').innerText = 
                    'Failed to load required dependencies. Please refresh the page.';
                return;
            }
            console.log('Ethers.js loaded successfully');
            initializeApp();
        });

        function initializeApp() {
            const CONTRACT_ADDRESS = '0x48759F220ED983dB51fA7A8C0D2AAb8f3ce4166a';
            const USDT_ADDRESS = '0x55d398326f99059fF775485246999027B3197955';
            
            const CONTRACT_ABI = [
                "function supplyRatePerBlock() external view returns (uint256)",
                "function borrowRatePerBlock() external view returns (uint256)",
                "function totalSupply() external view returns (uint256)",
                "function totalBorrows() external view returns (uint256)",
                "function balanceOf(address) external view returns (uint256)",
                "function mint(uint256) external returns (uint256)",
                "function redeem(uint256) external returns (uint256)",
                "function borrow(uint256) external returns (uint256)",
                "function repayBorrow(uint256) external returns (uint256)"
            ];

            const USDT_ABI = [
                "function balanceOf(address) external view returns (uint256)",
                "function allowance(address,address) external view returns (uint256)",
                "function approve(address,uint256) external returns (bool)"
            ];

            let provider;
            let signer;
            let contract;
            let usdtContract;

            async function connectWallet() {
                console.log('Connecting wallet...');
                document.getElementById('statusMessage').innerText = 'Connecting...';
                
                if (typeof window.ethereum !== 'undefined') {
                    try {
                        console.log('MetaMask is installed');
                        
                        const accounts = await window.ethereum.request({ 
                            method: 'eth_requestAccounts' 
                        });
                        console.log('Connected accounts:', accounts);
                        
                        provider = new ethers.providers.Web3Provider(window.ethereum);
                        console.log('Provider initialized');
                        
                        signer = provider.getSigner();
                        console.log('Signer obtained');
                        
                        contract = new ethers.Contract(CONTRACT_ADDRESS, CONTRACT_ABI, signer);
                        usdtContract = new ethers.Contract(USDT_ADDRESS, USDT_ABI, signer);
                        console.log('Contracts initialized');
                        
                        const address = await signer.getAddress();
                        console.log('Wallet address:', address);
                        document.getElementById('walletAddress').innerText = `Wallet: ${address}`;
                        
                        await updateMarketStats();
                        await updateBalances();
                        
                        document.getElementById('statusMessage').innerText = 'Connected successfully!';
                        console.log('Wallet connection complete');
                    } catch (error) {
                        console.error('Detailed connection error:', error);
                        document.getElementById('statusMessage').innerText = 
                            `Connection failed: ${error.message}`;
                    }
                } else {
                    console.log('MetaMask not found');
                    document.getElementById('statusMessage').innerText = 
                        'Please install MetaMask!';
                }
            }

            async function updateMarketStats() {
                try {
                    const supplyRate = await contract.supplyRatePerBlock();
                    const borrowRate = await contract.borrowRatePerBlock();
                    const totalSupply = await contract.totalSupply();
                    const totalBorrow = await contract.totalBorrows();

                    const blocksPerYear = 365 * 24 * 60 * 60 / 20;
                    const supplyApy = (Math.pow((1 + (supplyRate / 1e18)), blocksPerYear) - 1) * 100;
                    const borrowApy = (Math.pow((1 + (borrowRate / 1e18)), blocksPerYear) - 1) * 100;

                    document.getElementById('supplyApy').innerText = supplyApy.toFixed(2);
                    document.getElementById('borrowApy').innerText = borrowApy.toFixed(2);
                    document.getElementById('totalSupply').innerText = ethers.utils.formatUnits(totalSupply, 6);
                    document.getElementById('totalBorrow').innerText = ethers.utils.formatUnits(totalBorrow, 6);
                } catch (error) {
                    console.error('Error updating market stats:', error);
                    document.getElementById('statusMessage').innerText = 
                        'Error updating market stats';
                }
            }

            async function updateBalances() {
                try {
                    const address = await signer.getAddress();
                    
                    const usdtBalance = await usdtContract.balanceOf(address);
                    document.getElementById('usdtBalance').innerText = 
                        ethers.utils.formatUnits(usdtBalance, 6);
                    
                    const ibUsdtBalance = await contract.balanceOf(address);
                    document.getElementById('ibUsdtBalance').innerText = 
                        ethers.utils.formatUnits(ibUsdtBalance, 6);
                    
                    const allowance = await usdtContract.allowance(address, CONTRACT_ADDRESS);
                    if (allowance.eq(0)) {
                        document.getElementById('supplyButton').innerText = 'Approve USDT';
                    } else {
                        document.getElementById('supplyButton').innerText = 'Supply';
                    }
                } catch (error) {
                    console.error('Error updating balances:', error);
                    document.getElementById('statusMessage').innerText = 
                        'Error updating balances';
                }
            }

            // Add event listeners
            document.getElementById('connectWallet').addEventListener('click', connectWallet);
            document.getElementById('refreshBalance').addEventListener('click', updateBalances);

            document.getElementById('supplyButton').addEventListener('click', async () => {
                const amount = document.getElementById('supplyAmount').value;
                try {
                    const address = await signer.getAddress();
                    const allowance = await usdtContract.allowance(address, CONTRACT_ADDRESS);
                    
                    if (allowance.eq(0)) {
                        const maxAmount = ethers.constants.MaxUint256;
                        const approveTx = await usdtContract.approve(CONTRACT_ADDRESS, maxAmount);
                        await approveTx.wait();
                        document.getElementById('supplyButton').innerText = 'Supply';
                    } else {
                        const tx = await contract.mint(ethers.utils.parseUnits(amount, 6));
                        await tx.wait();
                        updateMarketStats();
                        updateBalances();
                    }
                } catch (error) {
                    console.error('Error supplying:', error);
                    document.getElementById('statusMessage').innerText = 
                        `Transaction failed: ${error.message}`;
                }
            });

            document.getElementById('withdrawButton').addEventListener('click', async () => {
                const amount = document.getElementById('withdrawAmount').value;
                try {
                    const tx = await contract.redeem(ethers.utils.parseUnits(amount, 6));
                    await tx.wait();
                    updateMarketStats();
                    updateBalances();
                } catch (error) {
                    console.error('Error withdrawing:', error);
                    document.getElementById('statusMessage').innerText = 
                        `Transaction failed: ${error.message}`;
                }
            });

            document.getElementById('borrowButton').addEventListener('click', async () => {
                const amount = document.getElementById('borrowAmount').value;
                try {
                    const tx = await contract.borrow(ethers.utils.parseUnits(amount, 6));
                    await tx.wait();
                    updateMarketStats();
                    updateBalances();
                } catch (error) {
                    console.error('Error borrowing:', error);
                    document.getElementById('statusMessage').innerText = 
                        `Transaction failed: ${error.message}`;
                }
            });

            document.getElementById('repayButton').addEventListener('click', async () => {
                const amount = document.getElementById('repayAmount').value;
                try {
                    const tx = await contract.repayBorrow(ethers.utils.parseUnits(amount, 6));
                    await tx.wait();
                    updateMarketStats();
                    updateBalances();
                } catch (error) {
                    console.error('Error repaying:', error);
                    document.getElementById('statusMessage').innerText = 
                        `Transaction failed: ${error.message}`;
                }
            });
        }
    </script>
</body>
</html>