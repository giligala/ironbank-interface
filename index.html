<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Iron Bank Interface</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }
        .container {
            background-color: #f5f5f5;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
        }
        .button {
            background-color: #4CAF50;
            border: none;
            color: white;
            padding: 15px 32px;
            text-align: center;
            text-decoration: none;
            display: inline-block;
            font-size: 16px;
            margin: 4px 2px;
            cursor: pointer;
            border-radius: 4px;
        }
        .input-group {
            margin: 10px 0;
        }
        input {
            padding: 10px;
            margin-right: 10px;
            border-radius: 4px;
            border: 1px solid #ddd;
        }
        #statusMessage {
            color: red;
            margin-top: 10px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h2>Wallet Connection</h2>
        <button class="button" id="connectButton">Connect Wallet</button>
        <p>Connected Address: <span id="connectedAddress">Not connected</span></p>
        <p>Network: <span id="networkName">Not connected</span></p>
    </div>

    <div class="container">
        <h2>Market Stats</h2>
        <p>Supply APY: <span id="supplyApy">Loading...</span>%</p>
        <p>Borrow APY: <span id="borrowApy">Loading...</span>%</p>
        <p>Total Supply: <span id="totalSupply">Loading...</span> USDT</p>
        <p>Total Borrow: <span id="totalBorrow">Loading...</span> USDT</p>
    </div>

    <div class="container">
        <h2>Your Balances</h2>
        <p>USDT Balance: <span id="usdtBalance">Loading...</span></p>
        <p>ibUSDT Balance: <span id="ibUsdtBalance">Loading...</span></p>
    </div>

    <div class="container">
        <h2>Supply</h2>
        <div class="input-group">
            <input type="number" id="supplyAmount" placeholder="Amount">
            <button class="button" id="supplyButton">Supply</button>
        </div>
    </div>

    <div class="container">
        <h2>Withdraw</h2>
        <div class="input-group">
            <input type="number" id="withdrawAmount" placeholder="Amount">
            <button class="button" id="withdrawButton">Withdraw</button>
        </div>
    </div>

    <div id="statusMessage"></div>

    <script src="https://cdn.ethers.io/lib/ethers-5.0.umd.min.js" type="application/javascript"></script>
    <script>
        let provider;
        let signer;
        let contract;
        let usdtContract;

        const CONTRACT_ADDRESS = "0x994A258c7Dec633865ACf5f89A572e6691DA35af";
        const USDT_ADDRESS = "0xdAC17F958D2ee523a2206206994597C13D831ec7";

        const CONTRACT_ABI = [
            "function mint(uint256) external returns (uint256)",
            "function redeem(uint256) external returns (uint256)",
            "function balanceOf(address) external view returns (uint256)",
            "function totalSupply() external view returns (uint256)",
            "function totalBorrows() external view returns (uint256)",
            "function borrowRatePerBlock() external view returns (uint256)",
            "function supplyRatePerBlock() external view returns (uint256)"
        ];

        const USDT_ABI = [
            "function approve(address, uint256) external returns (bool)",
            "function balanceOf(address) external view returns (uint256)",
            "function allowance(address, address) external view returns (uint256)"
        ];

        async function connectWallet() {
            if (typeof window.ethereum !== 'undefined') {
                try {
                    // Request account access
                    await window.ethereum.request({ method: 'eth_requestAccounts' });
                    
                    provider = new ethers.providers.Web3Provider(window.ethereum);
                    signer = provider.getSigner();
                    
                    const address = await signer.getAddress();
                    document.getElementById('connectedAddress').innerText = 
                        address.slice(0,6) + '...' + address.slice(-4);

                    const network = await provider.getNetwork();
                    document.getElementById('networkName').innerText = network.name;

                    contract = new ethers.Contract(CONTRACT_ADDRESS, CONTRACT_ABI, signer);
                    usdtContract = new ethers.Contract(USDT_ADDRESS, USDT_ABI, signer);

                    await updateBalances();
                    await updateMarketStats();
                    setupEventListeners();

                } catch (error) {
                    console.error("Error connecting wallet:", error);
                    document.getElementById('statusMessage').innerText = 
                        'Failed to connect wallet: ' + error.message;
                }
            } else {
                alert('Please install MetaMask!');
            }
        }

        async function updateBalances() {
            try {
                const address = await signer.getAddress();
                const usdtBalance = await usdtContract.balanceOf(address);
                const ibUsdtBalance = await contract.balanceOf(address);

                document.getElementById('usdtBalance').innerText = 
                    ethers.utils.formatUnits(usdtBalance, 6);
                document.getElementById('ibUsdtBalance').innerText = 
                    ethers.utils.formatUnits(ibUsdtBalance, 6);
            } catch (error) {
                console.error("Error updating balances:", error);
            }
        }

        async function updateMarketStats() {
            try {
                const supplyRate = await contract.supplyRatePerBlock();
                const borrowRate = await contract.borrowRatePerBlock();
                const totalSupply = await contract.totalSupply();
                const totalBorrow = await contract.totalBorrows();

                const blocksPerYear = 2102400;
                const supplyApy = (Math.pow((1 + supplyRate / 1e18), blocksPerYear) - 1) * 100;
                const borrowApy = (Math.pow((1 + borrowRate / 1e18), blocksPerYear) - 1) * 100;

                document.getElementById('supplyApy').innerText = supplyApy.toFixed(2);
                document.getElementById('borrowApy').innerText = borrowApy.toFixed(2);
                document.getElementById('totalSupply').innerText = 
                    ethers.utils.formatUnits(totalSupply, 6);
                document.getElementById('totalBorrow').innerText = 
                    ethers.utils.formatUnits(totalBorrow, 6);
            } catch (error) {
                console.error("Error updating market stats:", error);
            }
        }

        function setupEventListeners() {
            document.getElementById('supplyButton').addEventListener('click', async () => {
                try {
                    const amount = document.getElementById('supplyAmount').value;
                    const amountWei = ethers.utils.parseUnits(amount, 6);
                    
                    // First approve USDT spending
                    const approveTx = await usdtContract.approve(CONTRACT_ADDRESS, amountWei);
                    await approveTx.wait();
                    
                    // Then mint ibUSDT
                    const mintTx = await contract.mint(amountWei);
                    await mintTx.wait();
                    
                    await updateBalances();
                } catch (error) {
                    console.error("Supply error:", error);
                    document.getElementById('statusMessage').innerText = 
                        'Supply failed: ' + error.message;
                }
            });

            document.getElementById('withdrawButton').addEventListener('click', async () => {
                try {
                    const amount = document.getElementById('withdrawAmount').value;
                    const amountWei = ethers.utils.parseUnits(amount, 6);
                    
                    const tx = await contract.redeem(amountWei);
                    await tx.wait();
                    
                    await updateBalances();
                } catch (error) {
                    console.error("Withdraw error:", error);
                    document.getElementById('statusMessage').innerText = 
                        'Withdraw failed: ' + error.message;
                }
            });
        }

        // Connect button event listener
        document.getElementById('connectButton').addEventListener('click', connectWallet);

        // Setup network change listener
        if (window.ethereum) {
            window.ethereum.on('chainChanged', () => {
                window.location.reload();
            });
            window.ethereum.on('accountsChanged', () => {
                window.location.reload();
            });
        }
    </script>
</body>
</html>